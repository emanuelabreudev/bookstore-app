const LoginPage = require("../pageobjects/login.page");
const ShopPage = require("../pageobjects/shop.page");

describe("BookStore - Testes de Regress√£o Visual Avan√ßados", () => {
  describe("‚ùå REGRESS√ÉO: Simulando Mudan√ßas Visuais", () => {
    beforeEach(async () => {
      await LoginPage.open();
      await LoginPage.login("admin", "senha123");
      await browser.pause(2000);
    });

    it("‚úÖ BASELINE: Criar baseline do cabe√ßalho", async () => {
      const header = await $("header");

      await browser.saveElement(header, "header-baseline");

      const result = await browser.checkElement(header, "header-baseline");
      console.log(`üìä Baseline criada, diferen√ßa: ${result}%`);
    });

    it("‚ö†Ô∏è DEMO: Simular mudan√ßa no t√≠tulo (deve falhar ap√≥s primeira execu√ß√£o)", async () => {
      // Este teste demonstra como detectar mudan√ßas visuais
      // Na primeira execu√ß√£o, cria a baseline
      // Em execu√ß√µes subsequentes, se algo mudar, ser√° detectado

      const header = await $("header");

      // Comparar com baseline
      const result = await browser.checkElement(
        header,
        "header-regression-check",
        {
          // Op√ß√µes adicionais de compara√ß√£o
          ignoreAntialiasing: true,
          ignoreColors: false,
        }
      );

      console.log(`üìä Resultado da compara√ß√£o: ${result}%`);

      // Se houver mais de 0.5% de diferen√ßa, pode ser uma regress√£o
      if (result > 0.5) {
        console.warn(`‚ö†Ô∏è ATEN√á√ÉO: Detectada diferen√ßa visual de ${result}%!`);
        console.warn(`üîç Verifique as imagens em: test/visual/diff/`);
      }
    });

    it("‚úÖ COMPARA√á√ÉO: Produto antes e depois de adicionar ao carrinho", async () => {
      const product = await ShopPage.getProductByTitle("Clean Code");

      // Capturar estado inicial
      await browser.saveElement(product, "product-before-add");
      const before = await browser.checkElement(product, "product-before-add");

      // Adicionar ao carrinho
      await ShopPage.addProductToCart("Clean Code");
      await browser.pause(500);

      // Capturar estado ap√≥s adicionar
      await browser.saveElement(product, "product-after-add");
      const after = await browser.checkElement(product, "product-after-add");

      console.log(`üìä Estado inicial: ${before}%`);
      console.log(`üìä Estado ap√≥s adicionar: ${after}%`);

      // Os estados devem ser iguais (produto n√£o muda visualmente)
      if (before !== after) {
        console.warn(
          `‚ö†Ô∏è O produto mudou visualmente ap√≥s adicionar ao carrinho!`
        );
      }
    });

    it("‚úÖ COMPARA√á√ÉO: Diferentes estados do carrinho", async () => {
      // Estado 1: Carrinho vazio
      const cartEmpty = await $(".cart-section");
      await browser.saveElement(cartEmpty, "cart-state-empty");
      const emptyResult = await browser.checkElement(
        cartEmpty,
        "cart-state-empty"
      );

      // Estado 2: Carrinho com 1 item
      await ShopPage.addProductToCart("Clean Code");
      await browser.pause(500);
      const cartOne = await $(".cart-section");
      await browser.saveElement(cartOne, "cart-state-one-item");
      const oneResult = await browser.checkElement(
        cartOne,
        "cart-state-one-item"
      );

      // Estado 3: Carrinho com m√∫ltiplos itens
      await ShopPage.addProductToCart("Refactoring");
      await browser.pause(500);
      const cartMultiple = await $(".cart-section");
      await browser.saveElement(cartMultiple, "cart-state-multiple");
      const multipleResult = await browser.checkElement(
        cartMultiple,
        "cart-state-multiple"
      );

      console.log(`üìä Carrinho vazio: ${emptyResult}%`);
      console.log(`üìä Carrinho com 1 item: ${oneResult}%`);
      console.log(`üìä Carrinho com m√∫ltiplos: ${multipleResult}%`);

      // Todos devem ser diferentes entre si
      console.log(`‚úÖ Estados do carrinho capturados para compara√ß√£o futura`);
    });
  });

  describe("üéØ PRECIS√ÉO: Testes com √Åreas Ignoradas", () => {
    beforeEach(async () => {
      await LoginPage.open();
      await LoginPage.login("admin", "senha123");
      await browser.pause(2000);
    });

    it("‚úÖ IGNORAR: Elementos din√¢micos na compara√ß√£o", async () => {
      // Capturar p√°gina completa ignorando elementos que mudam
      const result = await browser.checkFullPageScreen("shop-ignore-dynamic", {
        // Ignorar elementos espec√≠ficos que podem variar
        ignore: [
          // Exemplo: ignorar timestamps, contadores, etc.
        ],
        // Aumentar toler√¢ncia para pequenas diferen√ßas
        savePerInstance: false,
        // Outras op√ß√µes
        ignoreAntialiasing: true,
      });

      console.log(`üìä Diferen√ßa (ignorando din√¢micos): ${result}%`);
    });

    it("‚úÖ FOCO: Comparar apenas √°rea espec√≠fica", async () => {
      // Focar apenas na √°rea de produtos
      const productsArea = await $("#products");

      const result = await browser.checkElement(
        productsArea,
        "products-area-focused",
        {
          // Remover elementos antes da compara√ß√£o
          removeElements: [
            // Elementos a serem removidos da compara√ß√£o
          ],
        }
      );

      console.log(`üìä Diferen√ßa na √°rea de produtos: ${result}%`);
    });
  });

  describe("üìê MULTI-RESOLU√á√ÉO: Testes em Diferentes Tamanhos", () => {
    const resolutions = [
      { name: "mobile-small", width: 320, height: 568 },
      { name: "mobile", width: 375, height: 667 },
      { name: "tablet", width: 768, height: 1024 },
      { name: "laptop", width: 1366, height: 768 },
      { name: "desktop", width: 1920, height: 1080 },
    ];

    resolutions.forEach((resolution) => {
      it(`‚úÖ RESOLU√á√ÉO: Testar layout em ${resolution.name} (${resolution.width}x${resolution.height})`, async () => {
        // Definir resolu√ß√£o
        await browser.setWindowSize(resolution.width, resolution.height);

        await LoginPage.open();
        await LoginPage.login("admin", "senha123");
        await browser.pause(2000);

        // Capturar em diferentes resolu√ß√µes
        await browser.saveFullPageScreen(`layout-${resolution.name}`);

        const result = await browser.checkFullPageScreen(
          `layout-${resolution.name}`
        );

        console.log(`üìä ${resolution.name}: ${result}% de diferen√ßa`);
      });
    });
  });

  describe("üîÑ ANIMA√á√ïES: Testes com Elementos Animados", () => {
    beforeEach(async () => {
      await LoginPage.open();
      await LoginPage.login("admin", "senha123");
      await browser.pause(2000);
    });

    it("‚úÖ AGUARDAR: Capturar ap√≥s anima√ß√µes completarem", async () => {
      const product = await ShopPage.getProductByTitle("Clean Code");

      // Mover mouse para ativar hover/anima√ß√£o
      await product.moveTo();

      // Aguardar anima√ß√£o completar
      await browser.pause(500);

      // Capturar ap√≥s anima√ß√£o
      await browser.saveElement(product, "product-after-animation");

      const result = await browser.checkElement(
        product,
        "product-after-animation",
        {
          // Configura√ß√µes para lidar com anima√ß√µes
          ignoreAntialiasing: true,
        }
      );

      console.log(`üìä Produto ap√≥s anima√ß√£o: ${result}%`);
    });
  });

  describe("üìä RELAT√ìRIOS: Gerando Dados para An√°lise", () => {
    it("‚úÖ COLETAR: M√∫ltiplas capturas para relat√≥rio", async () => {
      await LoginPage.open();

      // Captura 1: Login
      await browser.saveFullPageScreen("report-01-login");
      await browser.checkFullPageScreen("report-01-login");

      // Captura 2: Login com erro
      await LoginPage.login("wrong", "wrong");
      await browser.pause(500);
      await browser.saveFullPageScreen("report-02-login-error");
      await browser.checkFullPageScreen("report-02-login-error");

      // Captura 3: Login sucesso
      await LoginPage.login("admin", "senha123");
      await browser.pause(2000);
      await browser.saveFullPageScreen("report-03-shop");
      await browser.checkFullPageScreen("report-03-shop");

      // Captura 4: Com produtos no carrinho
      await ShopPage.addProductToCart("Clean Code");
      await browser.pause(500);
      await browser.saveFullPageScreen("report-04-cart-filled");
      await browser.checkFullPageScreen("report-04-cart-filled");

      console.log("üìä Todas as capturas foram salvas para relat√≥rio");
      console.log(
        "üí° Execute: npm run visual:report para gerar relat√≥rio HTML"
      );
    });
  });

  describe("‚ö° PERFORMANCE: Testes de Performance Visual", () => {
    it("‚úÖ MEDIR: Tempo de carregamento visual", async () => {
      const startTime = Date.now();

      await LoginPage.open();
      await browser.pause(1000);

      const loadTime = Date.now() - startTime;

      await browser.saveFullPageScreen("performance-login");
      const result = await browser.checkFullPageScreen("performance-login");

      console.log(`‚è±Ô∏è Tempo de carregamento: ${loadTime}ms`);
      console.log(`üìä Diferen√ßa visual: ${result}%`);

      // Verificar se o carregamento foi r√°pido
      if (loadTime > 3000) {
        console.warn(`‚ö†Ô∏è ATEN√á√ÉO: P√°gina demorou mais de 3s para carregar!`);
      }
    });

    it("‚úÖ COMPARAR: Performance entre p√°ginas", async () => {
      // Medir login
      const loginStart = Date.now();
      await LoginPage.open();
      await browser.pause(1000);
      const loginTime = Date.now() - loginStart;

      // Fazer login
      await LoginPage.login("admin", "senha123");

      // Medir loja
      const shopStart = Date.now();
      await browser.pause(2000);
      const shopTime = Date.now() - shopStart;

      console.log(`‚è±Ô∏è Login: ${loginTime}ms`);
      console.log(`‚è±Ô∏è Loja: ${shopTime}ms`);
      console.log(`üìä Total: ${loginTime + shopTime}ms`);
    });
  });

  describe("üé® TEMAS: Testes de Consist√™ncia Visual", () => {
    beforeEach(async () => {
      await LoginPage.open();
      await LoginPage.login("admin", "senha123");
      await browser.pause(2000);
    });

    it("‚úÖ CORES: Verificar paleta de cores consistente", async () => {
      // Capturar diferentes se√ß√µes para verificar consist√™ncia
      const header = await $("header");
      const products = await $("#products");
      const cart = await $(".cart-section");

      await browser.saveElement(header, "theme-header");
      await browser.saveElement(products, "theme-products");
      await browser.saveElement(cart, "theme-cart");

      const headerResult = await browser.checkElement(header, "theme-header");
      const productsResult = await browser.checkElement(
        products,
        "theme-products"
      );
      const cartResult = await browser.checkElement(cart, "theme-cart");

      console.log(`üìä Header: ${headerResult}%`);
      console.log(`üìä Produtos: ${productsResult}%`);
      console.log(`üìä Carrinho: ${cartResult}%`);
      console.log(`üé® Consist√™ncia visual verificada`);
    });

    it("‚úÖ TIPOGRAFIA: Verificar fontes e tamanhos", async () => {
      const elements = [
        { selector: "h1", name: "title" },
        { selector: "h2", name: "subtitle" },
        { selector: "h3", name: "card-title" },
        { selector: "button", name: "button" },
      ];

      for (const elem of elements) {
        const element = await $(elem.selector);
        await browser.saveElement(element, `typography-${elem.name}`);
        const result = await browser.checkElement(
          element,
          `typography-${elem.name}`
        );
        console.log(`üìä ${elem.name}: ${result}%`);
      }

      console.log(`‚úÖ Tipografia verificada em todos os elementos`);
    });
  });

  describe("üîç DETALHES: Testes Pixel-Perfect", () => {
    beforeEach(async () => {
      await LoginPage.open();
      await LoginPage.login("admin", "senha123");
      await browser.pause(2000);
    });

    it("‚úÖ PRECIS√ÉO: Compara√ß√£o com 0% de toler√¢ncia", async () => {
      const loginBtn = await $("#login-btn");

      // Capturar com precis√£o m√°xima
      await browser.saveElement(loginBtn, "pixel-perfect-button");

      const result = await browser.checkElement(
        loginBtn,
        "pixel-perfect-button",
        {
          // 0% de toler√¢ncia - deve ser exatamente igual
          rawMisMatchPercentage: true,
          ignoreAntialiasing: false,
          ignoreColors: false,
        }
      );

      if (result === 0) {
        console.log(`‚úÖ Elemento est√° EXATAMENTE igual √† baseline`);
      } else {
        console.log(`‚ö†Ô∏è Diferen√ßa de ${result}% detectada`);
      }
    });

    it("‚úÖ BORDES: Verificar bordas e sombras", async () => {
      const productCard = await $(".product-card");

      await browser.saveElement(productCard, "borders-and-shadows");

      const result = await browser.checkElement(
        productCard,
        "borders-and-shadows",
        {
          // Detectar diferen√ßas sutis em bordas
          ignoreAntialiasing: false,
        }
      );

      console.log(`üìä Bordas e sombras: ${result}%`);
    });

    it("‚úÖ ESPA√áAMENTO: Verificar padding e margins", async () => {
      const container = await $(".container");

      await browser.saveElement(container, "spacing-check");

      const result = await browser.checkElement(container, "spacing-check");

      console.log(`üìä Espa√ßamento: ${result}%`);

      if (result > 0) {
        console.warn(`‚ö†Ô∏è Poss√≠vel mudan√ßa no espa√ßamento detectada!`);
      }
    });
  });

  describe("üì± CROSS-BROWSER: Simula√ß√£o de Diferentes Browsers", () => {
    it("‚úÖ CHROME: Capturar baseline no Chrome", async () => {
      await LoginPage.open();
      await LoginPage.login("admin", "senha123");
      await browser.pause(2000);

      await browser.saveFullPageScreen("browser-chrome-baseline");
      const result = await browser.checkFullPageScreen(
        "browser-chrome-baseline"
      );

      console.log(`üìä Chrome baseline: ${result}%`);
      console.log(
        `üí° Use diferentes configs de wdio para testar outros browsers`
      );
    });
  });

  describe("üö® CASOS DE ERRO: Testes de Estados de Erro", () => {
    it("‚úÖ ERRO: Capturar estado de erro 404", async () => {
      // Tentar acessar p√°gina inexistente
      await browser.url("http://localhost:8080/nao-existe.html");
      await browser.pause(1000);

      await browser.saveFullPageScreen("error-404-page");
      const result = await browser.checkFullPageScreen("error-404-page");

      console.log(`üìä P√°gina 404: ${result}%`);
    });

    it("‚úÖ ERRO: Valida√ß√£o visual de campos obrigat√≥rios", async () => {
      await LoginPage.open();

      // Tentar submit sem preencher
      await LoginPage.btnLogin.click();
      await browser.pause(500);

      const loginForm = await $("#login-section");
      await browser.saveElement(loginForm, "form-validation-error");
      const result = await browser.checkElement(
        loginForm,
        "form-validation-error"
      );

      console.log(`üìä Erro de valida√ß√£o: ${result}%`);
    });

    it("‚úÖ ERRO: Produto sem estoque visual", async () => {
      await LoginPage.open();
      await LoginPage.login("admin", "senha123");
      await browser.pause(2000);

      const outOfStock = await ShopPage.getProductByTitle("Design Patterns");

      await browser.saveElement(outOfStock, "out-of-stock-visual");
      const result = await browser.checkElement(
        outOfStock,
        "out-of-stock-visual"
      );

      console.log(`üìä Produto sem estoque: ${result}%`);
    });
  });

  describe("üìà HIST√ìRICO: Tracking de Mudan√ßas ao Longo do Tempo", () => {
    it("‚úÖ SNAPSHOT: Criar snapshot versionado", async () => {
      await LoginPage.open();
      await LoginPage.login("admin", "senha123");
      await browser.pause(2000);

      // Criar snapshot com timestamp
      const timestamp = new Date().toISOString().split("T")[0];

      await browser.saveFullPageScreen(`snapshot-v1-${timestamp}`);
      const result = await browser.checkFullPageScreen(
        `snapshot-v1-${timestamp}`
      );

      console.log(`üìä Snapshot v1 (${timestamp}): ${result}%`);
      console.log(`üí° Use este padr√£o para acompanhar evolu√ß√£o visual`);
    });
  });
});
